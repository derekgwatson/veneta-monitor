<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Veneta Order Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<h1>Veneta Order Dashboard</h1>
<form method="get">
  <label>
    <input type="checkbox" name="show_hidden" value="1" onchange="this.form.submit()"
      {% if show_hidden %}checked{% endif %}>
    Show stale/unprocessed orders
  </label>
  &nbsp;&nbsp;
  <label>
    <input type="checkbox" name="show_invoiced" value="1" onchange="this.form.submit()"
      {% if show_invoiced %}checked{% endif %}>
    Show Invoiced and Cancelled Orders
  </label>
</form>

<p id="lastUpdated" data-utc="{{ now.strftime('%Y-%m-%dT%H:%M:%S') }}Z" style="color: #aaa; font-size: 0.9em;">
  Last updated: calculating...
</p>

<table border="1">
    <thead>
        <tr>
            <th>#</th>
            <th>Veneta Order Number</th>  <!-- Rename for clarity -->
            <th>Buz Order Number</th>     <!-- NEW -->
            <th>Received at Veneta FTP</th>
            <th>Received at Watson FTP</th>
            <th>Processed in Buz</th>
            <th>Buz Statuses</th>
            <th>Source</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for order in orders %}
          {% set is_stale = false %}

          {% if not order.buz_processed_time %}
            {% if order.local_ftp_time and (now - order.local_ftp_time).days > 2 %}
              {% set is_stale = true %}
            {% elif order.veneta_ftp_time and (now - order.veneta_ftp_time).days > 2 %}
              {% set is_stale = true %}
            {% endif %}
          {% endif %}

        <tr class="{% if is_stale %}stale {% endif %}{% if order.workflow_statuses and ('invoiced' in order.workflow_statuses.lower() or 'cancelled' in order.workflow_statuses.lower()) %}hideable{% endif %}">
            <td>{{ loop.index }}</td>
            <td>{{ order.order_number }}</td>
            <td>{{ order.buz_order_number or '-' }}</td>
            <td>{{ order.veneta_ftp_time.strftime('%d %b %Y') if order.veneta_ftp_time else '-' }}</td>
            <td>{{ order.local_ftp_time.strftime('%d %b %Y') if order.local_ftp_time else '-' }}</td>
            <td>{{ order.buz_processed_time.strftime('%d %b %Y') if order.buz_processed_time else '-' }}</td>
            <td>{{ order.workflow_statuses or '-' }}</td>
            <td>
              <span class="badge {{ 'bg-success' if order.src == 'Veneta' else 'bg-secondary' }}">
                {{ order.src or '-' }}
              </span>
            </td>

            <td>
              {% if is_stale %}
                <span class="badge bg-warning text-dark ms-1">‚ö†Ô∏è Stale</span>

              {% elif order.buz_processed_time %}
                <span class="badge bg-success">‚úÖ Processed</span>
              {% elif order.local_ftp_time %}
                <span class="badge bg-primary">üöõ At Local FTP</span>
              {% elif order.veneta_ftp_time %}
                <span class="badge bg-info text-dark">üì• Received from Veneta</span>
              {% else %}
                <span class="badge bg-secondary">‚è≥ Waiting</span>
              {% endif %}

            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<script>
function applyHideableToggle() {
  const show = document.querySelector('input[name="show_invoiced"]').checked;
  document.querySelectorAll('tr.hideable').forEach(row => {
    row.style.display = show ? '' : 'none';
  });
}

document.querySelector('input[name="show_invoiced"]').addEventListener('change', applyHideableToggle);
window.addEventListener('DOMContentLoaded', applyHideableToggle);
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const el = document.getElementById('lastUpdated');
    const utcTime = el.getAttribute('data-utc');
    const date = new Date(utcTime);
    const localString = date.toLocaleString(undefined, {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    el.textContent = `Last updated: ${localString}`;
  });
</script>

</body>
</html>
